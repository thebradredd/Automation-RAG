<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Automation Assistant</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/static/response_typing.js" defer></script>
  <link rel="stylesheet" href="/static/thinking.css">
</head>

<body class="bg-gray-50 min-h-screen w-full h-full">
<div class="w-full h-screen bg-white rounded-none shadow-none flex flex-col overflow-hidden">

    <!-- Header -->
    <div class="flex items-center gap-4 p-4 border-b">
      <div class="h-10 w-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-3xl flex items-center justify-center text-white font-bold overflow-auto"><img src="/static/sora-color.png" alt=""></div>
      <div class="flex-1">
        <div class="font-semibold">Automation Assistant</div>
        <div class="text-xs text-gray-500">Ask questions and get context-aware answers</div>
      </div>
      <div class="text-sm text-gray-400">Local</div>
    </div>

    <!-- Messages -->
    <div id="messages" class="flex-1 overflow-auto p-4 space-y-4"></div>

    <!-- Input -->
    <div class="p-4 bg-white mx-auto my-2 w-[65%]">
      <div class="flex gap-3 items-center">
        <textarea id="input" rows="1" placeholder="Ask a question..."class="flex-1 resize-none overflow-hidden rounded-full border px-6 py-1 focus:outline-none h-14 leading-[3.2rem] shadow-sm"></textarea>

        <div class="flex gap-2">
          <button id="sendBtn"class="p-3 rounded-full bg-black text-white shadow-lg shadow-black/40 hover:shadow-white/30 hover:scale-110 transition-all duration-300 flex items-center justify-center">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
          <path fill-rule="evenodd" d="M11.47 2.47a.75.75 0 0 1 1.06 0l7.5 7.5a.75.75 0 1 1-1.06 1.06l-6.22-6.22V21a.75.75 0 0 1-1.5 0V4.81l-6.22 6.22a.75.75 0 1 1-1.06-1.06l7.5-7.5Z" clip-rule="evenodd" />
          </svg>
        </button>

        </div>
      </div>

      <div id="error" class="mt-2 text-sm text-red-500 hidden"></div>
    </div>
  </div>

  <script>
    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const errorEl = document.getElementById("error");

    function addMessage(role, text, sources = []) {
      const msg = document.createElement("div");
      msg.className = `max-w-[90%] ${role === 'user' ? 'ml-auto text-right' : 'mr-auto text-left'}`;

      msg.innerHTML = `
        <div class="inline-block px-4 py-2 rounded-3xl ${role === 'user' ? 'text-black' : 'text-gray-800'}"style="${role === 'user' ? 'background-color: rgb(244,244,244);' : ''}">${text}</div>

        ${sources.length ? `<div class="mt-2 text-xs text-gray-500 flex flex-wrap gap-2">
          ${sources.map(s => `<div class='px-2 py-1 bg-gray-100 rounded-3xl border text-[11px]'>${s}</div>`).join('')}
        </div>` : ''}
      `;

      messagesEl.appendChild(msg);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function sendQuery() {

      sendBtn.disabled = true
      sendBtn.innerHTML = `<div class="w-6 h-6 border-4 border-white border-t-black rounded-full slow-spin animate-spin"></div>`

      const text = inputEl.value.trim();
      if (!text) return;

      errorEl.classList.add("hidden");
      addMessage("user", text);
      inputEl.value = "";

      // Loader
      const loadingId = Date.now();
      addMessage("assistant", `<span class="thinking-text">Thinking...</span>`, [], loadingId);

      try {
        const res = await fetch("http://127.0.0.1:8000/rag/query", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: text })
        });

        if (!res.ok) throw new Error(`Server Error ${res.status}`);
        const data = await res.json();

        // Remove loader
        messagesEl.lastChild.remove();
        sendBtn.disabled = false;
        sendBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
         <path fill-rule="evenodd" d="M11.47 2.47a.75.75 0 0 1 1.06 0l7.5 7.5a.75.75 0 1 1-1.06 1.06l-6.22-6.22V21a.75.75 0 0 1-1.5 0V4.81l-6.22 6.22a.75.75 0 1 1-1.06-1.06l7.5-7.5Z" clip-rule="evenodd" />
         </svg>
        `
        addMessage("assistant", data.answer, data.sources);
      } catch (err) {
        messagesEl.lastChild.remove();
        addMessage("assistant", "Error: " + err.message);
      }
    }

    sendBtn.addEventListener("click", sendQuery);

    inputEl.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendQuery();
      }
    });
  </script>
</body>
</html>
